<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ダッシュボード & タスク管理（設定付き）</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
          crossorigin="anonymous"></script>

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart.js（ダッシュボード用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="shortcut icon" href="./static/icons/favicon.ico">
  <link rel="manifest" href="manifest.json">

  <style>
    a.btn-link.nav-link { text-align: left; display: block; padding: 0.5rem 1rem; }

    /* 通知バッジ色 */
    .badge-perm-default { background: #6c757d; }
    .badge-perm-granted { background: #198754; }
    .badge-perm-denied  { background: #dc3545; }

    /* ===== タスク（モバイル用 list-group スワイプの見た目） ===== */
    .lg-swipe-wrap { position: relative; overflow: hidden; }
    .lg-swipe-bg {
      position: absolute; inset: 0;
      background: #ffe5e5;
      display: flex; align-items: center; justify-content: flex-end;
      padding-right: 16px; pointer-events: none;
    }
    .lg-swipe-fore { position: relative; transition: transform .15s ease; will-change: transform; background: #fff; }
    .text-truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    /* PCではテーブル、モバイルはリスト表示 */
    @media (max-width: 767.98px) {
      #tasksTableWrapper { display: none !important; }
      #tasksListMobileWrapper { display: block !important; }
    }
    @media (min-width: 768px) {
      #tasksTableWrapper { display: block !important; }
      #tasksListMobileWrapper { display: none !important; }
    }

    /* ===================== ダッシュボード用スタイル（スコープ化） ===================== */
    #dashboardSection { --gap: 16px; --header-h: 56px; }
    #dashboardSection .db-container { max-width: 1200px; margin: 0 auto; padding: 16px; background: #fff; }
    #dashboardSection .top-section { display: grid; grid-template-columns: 1fr; grid-gap: var(--gap); margin-bottom: 24px; }
    @media (min-width: 1024px) {
      #dashboardSection .top-section { grid-template-columns: repeat(5,1fr); }
      #dashboardSection .top-section .header-card { grid-column: span 3; }
      #dashboardSection #kpi-sales { grid-column: span 1; }
      #dashboardSection #kpi-unitprice { grid-column: span 1; }
    }
    #dashboardSection .header-card {
      background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08);
      padding:12px 16px;display:flex;align-items:center;justify-content:space-between
    }
    #dashboardSection .header-controls { display:grid;grid-template-columns:1fr;gap:10px }
    #dashboardSection .header-card select,
    #dashboardSection .header-card input[type="month"]{
      padding:10px 12px;border:1px solid #d0d5dd;border-radius:8px;background:#fafafa;min-height:40px
    }
    @media (min-width:768px){
      #dashboardSection .header-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    }

    #dashboardSection .kpi-card{
      background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);
      padding:16px;display:flex;flex-direction:column;justify-content:space-between;
      position:relative;min-height:110px;cursor:pointer
    }
    #dashboardSection .kpi-card h3{font-size:clamp(12px,2.2vw,14px);color:#666;margin-bottom:8px}
    #dashboardSection .kpi-card .value{font-size:clamp(22px,5.5vw,28px);font-weight:700;color:#2b3a67;line-height:1.2}
    #dashboardSection .kpi-card .trend{display:flex;align-items:center;margin-top:8px;font-size:12px}
    #dashboardSection .kpi-card .trend.up{color:#31b057}
    #dashboardSection .kpi-card .trend.down{color:#e12d39}
    #dashboardSection .kpi-card .trend .icon{margin-right:4px;font-size:14px}
    #dashboardSection .edit-btn{position:absolute;top:8px;right:8px;border:none;background:transparent;cursor:pointer;font-size:18px;color:#98a2b3;padding:6px;border-radius:8px}
    #dashboardSection .edit-btn:hover{background:#f2f4f7;color:#2b3a67}
    #dashboardSection .mini-score{position:absolute;top:8px;right:44px;background:#eef3ff;color:#2b3a67;padding:3px 9px;border-radius:999px;font-size:12px;font-weight:700}
    #dashboardSection .target-badge{position:absolute;right:8px;bottom:8px;background:#f9fafb;border:1px solid #e5e7eb;color:#667085;padding:3px 10px;border-radius:999px;font-size:11px}
    #dashboardSection .kpi-row{display:grid;grid-gap:var(--gap)}
    @media (min-width:768px) and (max-width:1023.98px){#dashboardSection .kpi-row{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:1024px){#dashboardSection .kpi-row{grid-template-columns:repeat(5,1fr)}}

    /* モバイル：全体2カラム化 + コンテンツ要素を全幅に */
    @media (max-width: 767.98px){
      #dashboardSection .db-container{display:grid;grid-template-columns:repeat(2,1fr);grid-gap:var(--gap)}
      #dashboardSection .top-section, #dashboardSection .kpi-row.row-2, #dashboardSection .kpi-row.row-3{display:contents}
      #dashboardSection .header-card{grid-column:1/-1}
      #dashboardSection .panel, #dashboardSection .chart-toolbar, #dashboardSection .chart-section{grid-column:1/-1}
      #dashboardSection .kpi-card{min-height:110px}
    }

    #dashboardSection .chart-toolbar{
      background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:12px 16px;margin-bottom:10px;
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;position:sticky;top:var(--header-h);z-index:50
    }
    #dashboardSection .chart-toolbar .group{display:flex;gap:8px;align-items:center}
    #dashboardSection .chart-toolbar select{
      padding:10px 12px;border:1px solid #d0d5dd;border-radius:8px;background:#fafafa;min-height:40px
    }

    #dashboardSection .chart-section{display:grid;grid-template-columns:1fr;grid-gap:24px;margin-bottom:24px}
    #dashboardSection .chart-card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);position:relative}
    #dashboardSection .chart-card canvas{position:absolute;inset:16px}
    @media (max-width:767.98px){#dashboardSection .chart-card{height:280px}}
    @media (min-width:768px){#dashboardSection .chart-card{height:0;padding-bottom:56.25%}}

    #dashboardSection .panel{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:16px;margin-bottom:24px}
    #dashboardSection .panel h4{margin-bottom:10px}
    #dashboardSection .rank-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
    #dashboardSection table.rank{width:100%;border-collapse:collapse;min-width:520px}
    #dashboardSection table.rank th, #dashboardSection table.rank td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px;white-space:nowrap}
    #dashboardSection table.rank th{color:#666}
    #dashboardSection .rank-badge{display:inline-block;min-width:28px;text-align:center;border-radius:999px;padding:2px 8px;background:#f0f3ff}
    #dashboardSection .gold{background:#fff7d6} .silver{background:#f2f4f7} .bronze{background:#ffe9d9}

    /* カスタムモーダル（ダッシュボード専用） */
    #dashboardSection .modal-lite{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:1000}
    #dashboardSection .modal-lite[hidden]{display:none}
    #dashboardSection .modal-lite .content{background:#fff;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.18);
      padding:16px;min-width:320px;max-width:92vw;max-height:92vh;overflow-y:auto;position:relative}
    #dashboardSection .modal-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;position:sticky;top:0;background:#fff;
      margin:-16px -16px 12px -16px;padding:12px 16px;border-bottom:1px solid #eee;border-top-left-radius:12px;border-top-right-radius:12px}
    #dashboardSection .title-wrap{display:flex;flex-direction:column;gap:2px;min-width:0;max-width:calc(100% - 48px)}
    #dashboardSection .title-line.store{font-weight:700;font-size:16px;color:#2b3a67;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #dashboardSection .title-line.sub{font-size:13px;color:#667085;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #dashboardSection .close-btn{width:36px;height:36px;border:none;border-radius:10px;background:#f2f4f7;color:#333;font-size:20px;line-height:1;cursor:pointer;flex:0 0 auto}
    #dashboardSection .close-btn:hover{background:#e5e7eb}
    #dashboardSection .form-row{margin-top:10px}
    #dashboardSection .form-row label{display:block;font-size:12px;color:#555;margin-bottom:4px}
    #dashboardSection .form-row input,#dashboardSection .form-row textarea{width:100%;padding:10px;border:1px solid #d0d5dd;border-radius:10px;background:#fafafa}
    #dashboardSection .form-row input:focus,#dashboardSection .form-row textarea:focus{outline:none;border-color:#2b3a67;background:#fff}
    #dashboardSection .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;position:sticky;bottom:0;background:#fff;padding-top:8px}
    #dashboardSection .btn-lite{padding:10px 14px;border:none;border-radius:10px;cursor:pointer}
    #dashboardSection .btn-lite.cancel{background:#f2f4f7}
    #dashboardSection .btn-lite.save{background:#2b3a67;color:#fff}
    #dashboardSection .hint{font-size:11px;color:#667085;margin-top:6px}
    @media (max-width:767.98px){
      #dashboardSection .db-container{padding:12px}
      #dashboardSection .kpi-card{padding:14px;min-height:104px}
      #dashboardSection .edit-btn{top:6px;right:6px}
      #dashboardSection .mini-score{top:6px;right:40px}
      #dashboardSection .target-badge{right:6px;bottom:6px;font-size:10px}
      #dashboardSection .modal-lite .content{width:100vw;height:100dvh;max-width:none;border-radius:0;padding:16px}
      #dashboardSection .modal-head{margin:-16px -16px 12px -16px;padding:12px 16px;border-radius:0}
    }
  </style>
</head>

<body>
  <!-- モバイル：オフキャンバス -->
  <nav class="navbar navbar-light bg-light d-md-none">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
        aria-controls="offcanvasNavbar" aria-label="メニュー">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="offcanvas offcanvas-start w-50" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="offcanvasNavbarLabel">店舗管理ツール</h5>
          <button class="btn-close" data-bs-dismiss="offcanvas" aria-label="閉じる"></button>
        </div>
        <div class="offcanvas-body">
          <ul class="navbar-nav flex-column">
            <li class="nav-item"><button class="btn btn-link nav-link" onclick="showDashboardSection(); closeOffcanvas();">ダッシュボード</button></li>
            <li class="nav-item"><button class="btn btn-link nav-link" onclick="showTaskSection(); closeOffcanvas();">タスク一覧</button></li>
            <li class="nav-item"><button class="btn btn-link nav-link" onclick="showSettingsSection(); closeOffcanvas();">設定</button></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- デスクトップ：サイドバー -->
      <nav class="col-md-2 d-none d-md-block bg-light sidebar">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item"><button class="btn btn-link nav-link" onclick="showDashboardSection()">ダッシュボード</button></li>
            <li class="nav-item"><button class="btn btn-link nav-link" onclick="showTaskSection()">タスク一覧</button></li>
            <li class="nav-item"><button class="btn btn-link nav-link" onclick="showSettingsSection()">設定</button></li>
          </ul>
        </div>
      </nav>

      <!-- メイン -->
      <main class="col-md-10 ms-sm-auto px-md-4">
        <div class="container mt-3">

          <!-- ダッシュボード -->
          <section id="dashboardSection" style="display:none;">
            <h1 class="mb-3">ダッシュボード</h1>
            <div class="db-container">
              <!-- 上段：ヘッダー + KPI -->
              <div class="top-section">
                <div class="header-card">
                  <div class="header-controls">
                    <div>
                      <label for="store-select">店舗（KPI）：</label>
                      <select id="store-select"></select>
                    </div>
                    <div>
                      <label for="target-date">日付：</label>
                      <input type="month" id="target-date" value="">
                    </div>
                  </div>
                </div>

                <div class="kpi-card" id="kpi-sales">
                  <h3>売上</h3>
                  <div class="value">-- 円</div>
                  <div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div>
                </div>
                <div class="kpi-card" id="kpi-unitprice">
                  <h3>単価</h3>
                  <div class="value">-- 円</div>
                  <div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div>
                </div>
              </div>

              <!-- 2段目 -->
              <div class="kpi-row row-2">
                <div class="kpi-card" id="kpi-labour-sales"><h3>人時売上高</h3><div class="value">-- 円</div><div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div></div>
                <div class="kpi-card" id="kpi-F"><h3>F</h3><div class="value">--%</div><div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div></div>
                <div class="kpi-card" id="kpi-D"><h3>D</h3><div class="value">--%</div><div class="trend down"><span class="icon">▼</span><span class="percent">--%</span></div></div>
                <div class="kpi-card" id="kpi-labour-cost"><h3>人件費</h3><div class="value">--%</div><div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div></div>
                <div class="kpi-card" id="kpi-inspection-sheet"><h3>臨店シート</h3><div class="value">--</div><div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div></div>
              </div>

              <!-- 3段目 -->
              <div class="kpi-row row-3">
                <div class="kpi-card" id="kpi-mtg-rate"><h3>店舗MTG参加率</h3><div class="value">--%</div><div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div></div>
                <div class="kpi-card" id="kpi-cs-score"><h3>CSアンケート</h3><div class="value">-- 点</div><div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div></div>
                <div class="kpi-card" id="kpi-interview-progress"><h3>面談進捗</h3><div class="value">--%</div><div class="trend down"><span class="icon">▼</span><span class="percent">--%</span></div></div>
                <div class="kpi-card" id="kpi-referral-hires"><h3>PAリファラル採用</h3><div class="value">-- 名</div><div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div></div>
                <div class="kpi-card" id="kpi-score"><h3>点数（総合）</h3><div class="value">-- / 110点</div><div class="trend up"><span class="icon">▲</span><span class="percent">--%</span></div></div>
              </div>

              <!-- ランキング -->
              <div class="panel" id="score-ranking">
                <h4>6店舗 点数ランキング（当月 / 110点満点）</h4>
                <div class="rank-wrap">
                  <table class="rank" id="score-ranking-table">
                    <thead><tr><th>#</th><th>店舗名</th><th>点数</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <!-- グラフツールバー -->
              <div class="chart-toolbar">
                <div class="group">
                  <label for="chart-store-select">店舗（グラフ）：</label>
                  <select id="chart-store-select"></select>
                </div>
                <div class="group">
                  <label for="fiscal-year">期：</label>
                  <select id="fiscal-year"></select>
                </div>
                <div class="group">
                  <label style="display:flex;gap:6px;align-items:center;">
                    <input type="checkbox" id="toggle-yoy" checked> 昨対比(%) 表示
                  </label>
                </div>
              </div>

              <!-- グラフ -->
              <div class="chart-section">
                <div class="chart-card"><canvas id="salesChart"></canvas></div>
                <div class="chart-card"><canvas id="unitPriceChart"></canvas></div>
                <div class="chart-card"><canvas id="labourSalesChart"></canvas></div>
              </div>

              <!-- 🔽 ここから：仮説／ネクスト編集モーダル（ダッシュボード専用） -->
              <div id="hypo-modal" class="modal-lite" hidden>
                <div class="content">
                  <div class="modal-head">
                    <div class="title-wrap">
                      <div class="title-line store" id="hypo-title-store"></div>
                      <div class="title-line sub" id="hypo-title-sub"></div>
                    </div>
                    <button class="close-btn" id="hypo-close" aria-label="閉じる">×</button>
                  </div>
                  <input type="hidden" id="hypo-id">
                  <input type="hidden" id="hypo-store">
                  <input type="hidden" id="hypo-month">
                  <input type="hidden" id="hypo-item">
                  <div class="form-row">
                    <label>仮説</label>
                    <textarea id="hypo-text" rows="4" placeholder="仮説を入力"></textarea>
                  </div>
                  <div class="form-row">
                    <label>ネクストアクション</label>
                    <textarea id="next-text" rows="4" placeholder="次にやることを入力"></textarea>
                  </div>
                  <div class="actions">
                    <button class="btn-lite save" id="hypo-save">保存</button>
                  </div>
                </div>
              </div>
              <!-- 🔼 ここまで -->
            </div>
          </section>

          <!-- タスク一覧 -->
          <section id="taskSection" style="display:none;">
            <!-- （前回の内容のまま） -->
            <h1 class="mb-3">タスク一覧</h1>
            <div class="border rounded p-3 mb-3 mt-3">
              <h2 class="h5 mb-3">タスク追加</h2>
              <div class="row g-2 align-items-end">
                <div class="col-12 col-md-auto">
                  <label for="taskAddStoreSelect" class="form-label">店舗名</label>
                  <select id="taskAddStoreSelect" class="form-select"><option value="">店舗を選択</option></select>
                </div>
                <div class="col-12 col-md-auto">
                  <label for="taskAddItemInput" class="form-label">項目</label>
                  <select id="taskAddItemInput" class="form-select">
                    <option value="">項目を選択</option>
                    <option value="売上">売上</option><option value="単価">単価</option>
                    <option value="人時売上高">人時売上高</option><option value="F">F</option>
                    <option value="D">D</option><option value="人件費">人件費</option>
                    <option value="臨店シート">臨店シート</option><option value="CS調査">CS調査</option>
                    <option value="面談進捗">面談進捗</option><option value="ESアンケート">ESアンケート</option>
                    <option value="PAリファラル採用">PAリファラル採用</option>
                  </select>
                </div>
                <div class="col-12 col-md">
                  <label for="taskAddDetailInput" class="form-label">タスク</label>
                  <input id="taskAddDetailInput" class="form-control" placeholder="例: 棚割り変更">
                </div>
                <div class="col-6 col-md-auto">
                  <label for="taskAddDueInput" class="form-label">期限</label>
                  <input type="date" id="taskAddDueInput" class="form-control">
                </div>
                <div class="col-6 col-md-auto">
                  <label for="taskAddOwnerInput" class="form-label">責任者</label>
                  <input id="taskAddOwnerInput" class="form-control" placeholder="例: 佐藤">
                </div>
                <div class="col-12 col-md-auto">
                  <button class="btn btn-primary w-100" onclick="addTaskFromList()"><i class="bi bi-plus-lg me-1"></i>追加</button>
                </div>
              </div>
            </div>

            <div class="mb-3 d-flex flex-wrap align-items-center gap-2">
              <div>
                <label for="storeSelectTask" class="form-label me-2 mb-0">店舗選択:</label>
                <select id="storeSelectTask" class="form-select d-inline-block w-auto" onchange="fetchAndDisplayTasks()"></select>
              </div>
              <button id="refreshTasksBtn" class="btn btn-outline-secondary" onclick="refreshTasks?.()">
                <i class="bi bi-arrow-repeat me-1"></i>最新表示
              </button>
            </div>

            <div id="tasksTableWrapper" class="table-responsive">
              <table id="tasksTable" class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th id="thStore" class="sort-header" onclick="sortTasks('店舗名')">店舗</th>
                    <th id="thItem"  class="sort-header" onclick="sortTasks('項目')">項目</th>
                    <th id="thTask"  class="sort-header" onclick="sortTasks('タスク')">タスク</th>
                    <th id="thDue"   class="sort-header" onclick="sortTasks('期限')">期限</th>
                    <th id="thOwner" class="sort-header" onclick="sortTasks('責任者')">責任者</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div id="tasksListMobileWrapper" class="my-2" style="display:none;">
              <div id="tasksListMobile" class="list-group list-group-flush"></div>
            </div>
          </section>

          <!-- 設定 -->
          <section id="settingsSection" style="display:none;">
            <!-- （前回の内容のまま） -->
            <h1 class="mb-3">設定</h1>
            <div class="border rounded p-3 mb-4">
              <h2 class="h5 mb-3">通知</h2>
              <div class="d-flex align-items-center gap-3">
                <button id="btnNotif" class="btn btn-primary" onclick="requestNotificationPermission()">通知の許可</button>
                <span id="notificationStatus" class="badge rounded-pill badge-perm-default">未判定</span>
              </div>
              <p class="text-muted mt-2 mb-0">ブラウザの通知許可状況に応じてバッジとボタンが切り替わります。</p>
            </div>

            <div class="border rounded p-3">
              <h2 class="h5 mb-3">CSVアップロード</h2>
              <p>下記エリアにCSVファイルをドラッグ＆ドロップしてください。</p>
              <div id="csvDropArea" class="border border-primary rounded p-5 text-center"
                   ondragenter="handleDragEnter(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
                ここにCSVファイルをドロップ
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>
  </div>

  <!-- スクリプト -->
  <script type="module" src="scripts.js"></script>
</body>
</html>
